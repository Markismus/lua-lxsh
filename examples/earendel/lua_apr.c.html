<html>
<head>
<style type="text/css">
html, body { margin: 0; padding: 0; }
pre { margin: 0; padding: 1em; }
</style>
</head>
<body><pre style="color: #000; background-color: #FFF"><span style="color: #558817">/* Miscellaneous functions module for the Lua/APR binding.
 *
 * Author: Peter Odding &lt;peter@peterodding.com&gt;
 * Last Change: January 8, 2011
 * Homepage: <a href="http://peterodding.com/code/lua/apr/" style="color: #272fc2">http://peterodding.com/code/lua/apr/</a>
 * License: MIT
 */</span>

<span style="color: #a33243">#include "lua_apr.h"</span>
<span style="color: #a33243">#include &lt;apr_portable.h&gt;</span>

<span style="color: #558817">/* Used to make sure that APR is only initialized once. */</span>
<span style="color: #2239a8; font-weight: bold">static</span> <span style="color: #2239a8; font-weight: bold">int</span> apr_was_initialized <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">;</span>

<span style="color: #558817">/* Used to locate global memory pool used by library functions. */</span>
<span style="color: #2239a8; font-weight: bold">static</span> <span style="color: #2239a8; font-weight: bold">int</span> mp_regidx <span style="color: #2239a8; font-weight: bold">=</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-LUA_NOREF" style="color: #0e7c6b; text-decoration: none">LUA_NOREF</a><span style="color: #2239a8; font-weight: bold">;</span>

<span style="color: #558817">/* luaopen_apr_core() initializes the binding and library. {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> luaopen_apr_core<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  apr_status_t status<span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #558817">/* Table of library functions. */</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#luaL_Reg" style="color: #0e7c6b; text-decoration: none">luaL_Reg</a> functions<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #2239a8; font-weight: bold">]</span> <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #2239a8; font-weight: bold">{</span>

    <span style="color: #558817">/* lua_apr.c -- the "main" file. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"platform_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_platform_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"version_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_version_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"os_default_encoding"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_os_default_encoding <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"os_locale_encoding"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_os_locale_encoding <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"type"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_type <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* base64.c -- base64 encoding/decoding. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"base64_encode"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_base64_encode <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"base64_decode"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_base64_decode <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* crypt.c -- cryptographic functions. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"md5_init"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_md5_init <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"md5_encode"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_md5_encode <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"password_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_password_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"password_validate"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_password_validate <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"sha1_init"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_sha1_init <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* date.c -- date parsing. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"date_parse_http"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_date_parse_http <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"date_parse_rfc"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_date_parse_rfc <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* dbm.c -- dbm routines. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dbm_open"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dbm_open <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dbm_getnames"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dbm_getnames <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* env.c -- environment variable handling. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"env_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_env_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"env_set"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_env_set <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"env_delete"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_env_delete <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* filepath.c -- filepath manipulation. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_root"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_root <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_parent"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_parent <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_name"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_name <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_merge"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_merge <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_list_split"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_list_split <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_list_merge"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_list_merge <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"filepath_set"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_filepath_set <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* fnmatch.c -- filename matching. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"fnmatch"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_fnmatch <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"fnmatch_test"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_fnmatch_test <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* io_dir.c -- directory manipulation. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"temp_dir_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_temp_dir_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dir_make"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dir_make <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dir_make_recursive"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dir_make_recursive <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dir_remove"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dir_remove <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dir_remove_recursive"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dir_remove_recursive <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"dir_open"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_dir_open <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* io_file.c -- file i/o handling. */</span>
<span style="color: #a33243">#   if APR_MAJOR_VERSION &gt; 1 || (APR_MAJOR_VERSION == 1 &amp;&amp; APR_MINOR_VERSION &gt;= 4)</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_link"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_link <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
<span style="color: #a33243">#   endif</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_copy"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_copy <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_append"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_append <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_rename"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_rename <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_remove"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_remove <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_mtime_set"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_mtime_set <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_attrs_set"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_attrs_set <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_perms_set"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_perms_set <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"stat"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_stat <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"file_open"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_file_open <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* io_net.c -- network i/o handling. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"socket_create"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_socket_create <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"hostname_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_hostname_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"host_to_addr"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_host_to_addr <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"addr_to_host"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_addr_to_host <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* io_pipe.c -- pipe i/o handling. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"pipe_open_stdin"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_pipe_open_stdin <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"pipe_open_stdout"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_pipe_open_stdout <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"pipe_open_stderr"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_pipe_open_stderr <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"namedpipe_create"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_namedpipe_create <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"pipe_create"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_pipe_create <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* proc -- process handling. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"proc_create"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_proc_create <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"proc_detach"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_proc_detach <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
<span style="color: #a33243">#   if APR_HAS_FORK</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"proc_fork"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_proc_fork <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
<span style="color: #a33243">#   endif</span>

    <span style="color: #558817">/* str.c -- string handling. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"strnatcmp"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_strnatcmp <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"strnatcasecmp"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_strnatcasecmp <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"strfsize"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_strfsize <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"tokenize_to_argv"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_tokenize_to_argv <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* time.c -- time management */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"sleep"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_sleep <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"time_now"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_time_now <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"time_explode"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_time_explode <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"time_implode"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_time_implode <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"time_format"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_time_format <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* uri.c -- URI parsing/unparsing. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"uri_parse"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_uri_parse <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"uri_unparse"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_uri_unparse <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"uri_port_of_scheme"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_uri_port_of_scheme <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* user.c -- user/group identification. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"user_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_user_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"user_homepath_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_user_homepath_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* uuid.c -- UUID generation. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"uuid_get"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_uuid_get <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"uuid_format"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_uuid_format <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"uuid_parse"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_uuid_parse <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #558817">/* xlate.c -- character encoding translation. */</span>
    <span style="color: #2239a8; font-weight: bold">{</span> <span style="color: #a8660d">"xlate"</span><span style="color: #2239a8; font-weight: bold">,</span> lua_apr_xlate <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">,</span>

    <span style="color: #2239a8; font-weight: bold">{</span> NULL<span style="color: #2239a8; font-weight: bold">,</span> NULL <span style="color: #2239a8; font-weight: bold">}</span>
  <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #558817">/* Initialize the library (only once per process). */</span>
  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">!</span>apr_was_initialized<span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">(</span>status <span style="color: #2239a8; font-weight: bold">=</span> apr_initialize<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">!=</span> APR_SUCCESS<span style="color: #2239a8; font-weight: bold">)</span>
      raise_error_status<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> status<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span><a href="http://linux.die.net/man/3/atexit" style="color: #0e7c6b; text-decoration: none">atexit</a><span style="color: #2239a8; font-weight: bold">(</span>apr_terminate<span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">!=</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">)</span>
      raise_error_message<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"Lua/APR: Failed to register apr_terminate()"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    apr_was_initialized <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
 <span style="color: #2239a8; font-weight: bold">}</span>

  <span style="color: #558817">/* Create the table of global functions. */</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_createtable" style="color: #0e7c6b; text-decoration: none">lua_createtable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span> count<span style="color: #2239a8; font-weight: bold">(</span>functions<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#luaL_register" style="color: #0e7c6b; text-decoration: none">luaL_register</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> NULL<span style="color: #2239a8; font-weight: bold">,</span> functions<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #558817">/* Let callers of process:user_set() know whether it requires a password. */</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushboolean" style="color: #0e7c6b; text-decoration: none">lua_pushboolean</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> APR_PROCATTR_USER_SET_REQUIRES_PASSWORD<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_setfield" style="color: #0e7c6b; text-decoration: none">lua_setfield</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"user_set_requires_password"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #558817">/* Let callers of apr.socket_create() know whether it supports IPv6. */</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushboolean" style="color: #0e7c6b; text-decoration: none">lua_pushboolean</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> APR_HAVE_IPV6<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_setfield" style="color: #0e7c6b; text-decoration: none">lua_setfield</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"socket_supports_ipv6"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* apr.platform_get() -&gt; name {{{1
 * 
 * Get the name of the platform for which the Lua/APR binding was compiled.
 * Returns one of the following strings:
 *
 *  - `'UNIX'`
 *  - `'WIN32'`
 *  - `'NETWARE'`
 *  - `'OS2'`
 *
 * Please note that the labels returned by `apr.platform_get()` don't imply
 * that these platforms are fully supported; the author of the Lua/APR binding
 * doesn't have NETWARE and OS2 environments available for testing.
 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> lua_apr_platform_get<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
<span style="color: #a33243"># if defined(WIN32)</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"WIN32"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #a33243"># elif defined(NETWARE)</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"NETWARE"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #a33243"># elif defined(OS2)</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"OS2"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #a33243"># else</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"UNIX"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #a33243"># endif</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* apr.version_get() -&gt; apr_version, apu_version {{{1
 *
 * Get the version numbers of the Apache Portable Runtime and its utility
 * library as strings. Each string contains three numbers separated by dots.
 * The numbers have the following meaning:
 *
 *  - The 1st number is used for major [API] [api] changes that can cause
 *    compatibility problems between the Lua/APR binding and the APR and
 *    APR-util libraries
 *  - The 2nd number is used for minor API changes that shouldn't impact
 *    existing functionality in the Lua/APR binding
 *  - The 3rd number is used exclusively for bug fixes
 *
 * This function can be useful when you want to know whether a certain bug fix
 * has been applied to APR and/or APR-util or if you want to report a bug in
 * APR, APR-util or the Lua/APR binding.
 *
 * If you're looking for the version of the Lua/APR binding you can use the
 * `apr._VERSION` string, but note that Lua/APR currently does not use the
 * above versioning rules.
 *
 * [api]: <a href="http://en.wikipedia.org/wiki/Application_programming_interface" style="color: #272fc2">http://en.wikipedia.org/wiki/Application_programming_interface</a>
 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> lua_apr_version_get<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> apr_version_string<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> apu_version_string<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* apr.os_default_encoding() -&gt; name {{{1
 *
 * Get the name of the system default character set as a string.
 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> lua_apr_os_default_encoding<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> apr_os_default_encoding<span style="color: #2239a8; font-weight: bold">(</span>to_pool<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* apr.os_locale_encoding() -&gt; name {{{1
 *
 * Get the name of the current locale character set as a string. If the current
 * locale's data cannot be retrieved on this system, the name of the system
 * default character set is returned instead.
 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> lua_apr_os_locale_encoding<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> apr_os_locale_encoding<span style="color: #2239a8; font-weight: bold">(</span>to_pool<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* apr.type(object) -&gt; name {{{1
 *
 * Return the type of a userdata value as a string. If @object is of a known
 * type one of the strings `'file'`, `'directory'`, `'socket'`, `'process'` or
 * `'dbm'` will be returned, otherwise nothing is returned.
 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> lua_apr_type<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  lua_apr_objtype <span style="color: #2239a8; font-weight: bold">*</span>types<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #2239a8; font-weight: bold">]</span> <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <span style="color: #2239a8; font-weight: bold">&amp;</span>lua_apr_file_type<span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">&amp;</span>lua_apr_dir_type<span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">&amp;</span>lua_apr_socket_type<span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">&amp;</span>lua_apr_proc_type<span style="color: #2239a8; font-weight: bold">,</span>
    <span style="color: #2239a8; font-weight: bold">&amp;</span>lua_apr_dbm_type
  <span style="color: #2239a8; font-weight: bold">}</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">int</span> i<span style="color: #2239a8; font-weight: bold">;</span>

  <a href="http://www.lua.org/manual/5.1/manual.html#lua_settop" style="color: #0e7c6b; text-decoration: none">lua_settop</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#luaL_checktype" style="color: #0e7c6b; text-decoration: none">luaL_checktype</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span> LUA_TUSERDATA<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_getmetatable" style="color: #0e7c6b; text-decoration: none">lua_getmetatable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #2239a8; font-weight: bold">for</span> <span style="color: #2239a8; font-weight: bold">(</span>i <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">;</span> i <span style="color: #2239a8; font-weight: bold">&lt;</span> count<span style="color: #2239a8; font-weight: bold">(</span>types<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span> i<span style="color: #2239a8; font-weight: bold">++</span><span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    get_metatable<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> types<span style="color: #2239a8; font-weight: bold">[</span>i<span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_rawequal" style="color: #0e7c6b; text-decoration: none">lua_rawequal</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">3</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
      <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> types<span style="color: #2239a8; font-weight: bold">[</span>i<span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">-&gt;</span>friendlyname<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
      <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
    <span style="color: #2239a8; font-weight: bold">}</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pop" style="color: #0e7c6b; text-decoration: none">lua_pop</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span>

  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* to_pool() returns the global memory pool from the registry. {{{1 */</span>

apr_pool_t <span style="color: #2239a8; font-weight: bold">*</span>to_pool<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  apr_pool_t <span style="color: #2239a8; font-weight: bold">*</span>memory_pool<span style="color: #2239a8; font-weight: bold">;</span>
  apr_status_t status<span style="color: #2239a8; font-weight: bold">;</span>

  <a href="http://www.lua.org/manual/5.1/manual.html#luaL_checkstack" style="color: #0e7c6b; text-decoration: none">luaL_checkstack</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"not enough stack space to get memory pool"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>

  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span>mp_regidx <span style="color: #2239a8; font-weight: bold">==</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-LUA_NOREF" style="color: #0e7c6b; text-decoration: none">LUA_NOREF</a><span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    status <span style="color: #2239a8; font-weight: bold">=</span> apr_pool_create<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">&amp;</span>memory_pool<span style="color: #2239a8; font-weight: bold">,</span> NULL<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span>status <span style="color: #2239a8; font-weight: bold">!=</span> APR_SUCCESS<span style="color: #2239a8; font-weight: bold">)</span>
      raise_error_status<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> status<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushlightuserdata" style="color: #0e7c6b; text-decoration: none">lua_pushlightuserdata</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> memory_pool<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    mp_regidx <span style="color: #2239a8; font-weight: bold">=</span> <a href="http://www.lua.org/manual/5.1/manual.html#luaL_ref" style="color: #0e7c6b; text-decoration: none">luaL_ref</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-LUA_REGISTRYINDEX" style="color: #0e7c6b; text-decoration: none">LUA_REGISTRYINDEX</a><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span> <span style="color: #2239a8; font-weight: bold">else</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_rawgeti" style="color: #0e7c6b; text-decoration: none">lua_rawgeti</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-LUA_REGISTRYINDEX" style="color: #0e7c6b; text-decoration: none">LUA_REGISTRYINDEX</a><span style="color: #2239a8; font-weight: bold">,</span> mp_regidx<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    memory_pool <span style="color: #2239a8; font-weight: bold">=</span> <a href="http://www.lua.org/manual/5.1/manual.html#lua_touserdata" style="color: #0e7c6b; text-decoration: none">lua_touserdata</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    apr_pool_clear<span style="color: #2239a8; font-weight: bold">(</span>memory_pool<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pop" style="color: #0e7c6b; text-decoration: none">lua_pop</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span>

  <span style="color: #2239a8; font-weight: bold">return</span> memory_pool<span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* status_to_message() converts APR status codes to error messages. {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> status_to_message<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">,</span> apr_status_t status<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <span style="color: #2239a8; font-weight: bold">char</span> message<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #a8660d">512</span><span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">;</span>
  apr_strerror<span style="color: #2239a8; font-weight: bold">(</span>status<span style="color: #2239a8; font-weight: bold">,</span> message<span style="color: #2239a8; font-weight: bold">,</span> count<span style="color: #2239a8; font-weight: bold">(</span>message<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushstring" style="color: #0e7c6b; text-decoration: none">lua_pushstring</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> message<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* push_status() returns true for APR_SUCCESS or the result of status_to_message(). {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> push_status<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">,</span> apr_status_t status<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span>status <span style="color: #2239a8; font-weight: bold">==</span> APR_SUCCESS<span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushboolean" style="color: #0e7c6b; text-decoration: none">lua_pushboolean</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span> <span style="color: #2239a8; font-weight: bold">else</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <span style="color: #2239a8; font-weight: bold">return</span> push_error_status<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> status<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* push_error_status() converts APR status codes to (nil, message, code). {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> push_error_status<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">,</span> apr_status_t status<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushnil" style="color: #0e7c6b; text-decoration: none">lua_pushnil</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  status_to_message<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> status<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  status_to_name<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> status<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">3</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* new_object() allocates userdata of the given type. {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">void</span> <span style="color: #2239a8; font-weight: bold">*</span>new_object<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">,</span> lua_apr_objtype <span style="color: #2239a8; font-weight: bold">*</span>T<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <span style="color: #2239a8; font-weight: bold">void</span> <span style="color: #2239a8; font-weight: bold">*</span>object<span style="color: #2239a8; font-weight: bold">;</span>

  object <span style="color: #2239a8; font-weight: bold">=</span> <a href="http://www.lua.org/manual/5.1/manual.html#lua_newuserdata" style="color: #0e7c6b; text-decoration: none">lua_newuserdata</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>objsize<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span>object <span style="color: #2239a8; font-weight: bold">!=</span> NULL<span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <a href="http://linux.die.net/man/3/memset" style="color: #0e7c6b; text-decoration: none">memset</a><span style="color: #2239a8; font-weight: bold">(</span>object<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>objsize<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    get_metatable<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_setmetatable" style="color: #0e7c6b; text-decoration: none">lua_setmetatable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    getdefaultenv<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_setfenv" style="color: #0e7c6b; text-decoration: none">lua_setfenv</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span>
  <span style="color: #2239a8; font-weight: bold">return</span> object<span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #2239a8; font-weight: bold">void</span> getdefaultenv<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #558817">/* {{{1 */</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <span style="color: #2239a8; font-weight: bold">const</span> <span style="color: #2239a8; font-weight: bold">char</span> <span style="color: #2239a8; font-weight: bold">*</span>key <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #a8660d">"Lua/APR default environment for userdata"</span><span style="color: #2239a8; font-weight: bold">;</span>

  <a href="http://www.lua.org/manual/5.1/manual.html#lua_getfield" style="color: #0e7c6b; text-decoration: none">lua_getfield</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-LUA_REGISTRYINDEX" style="color: #0e7c6b; text-decoration: none">LUA_REGISTRYINDEX</a><span style="color: #2239a8; font-weight: bold">,</span> key<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">!</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_istable" style="color: #0e7c6b; text-decoration: none">lua_istable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pop" style="color: #0e7c6b; text-decoration: none">lua_pop</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_newtable" style="color: #0e7c6b; text-decoration: none">lua_newtable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pushvalue" style="color: #0e7c6b; text-decoration: none">lua_pushvalue</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_setfield" style="color: #0e7c6b; text-decoration: none">lua_setfield</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-LUA_REGISTRYINDEX" style="color: #0e7c6b; text-decoration: none">LUA_REGISTRYINDEX</a><span style="color: #2239a8; font-weight: bold">,</span> key<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* check_object() validates objects created by new_object(). {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">void</span> <span style="color: #2239a8; font-weight: bold">*</span>check_object<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">int</span> idx<span style="color: #2239a8; font-weight: bold">,</span> lua_apr_objtype <span style="color: #2239a8; font-weight: bold">*</span>T<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <span style="color: #2239a8; font-weight: bold">int</span> valid <span style="color: #2239a8; font-weight: bold">=</span> <span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">;</span>
  get_metatable<span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_getmetatable" style="color: #0e7c6b; text-decoration: none">lua_getmetatable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> idx<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  valid <span style="color: #2239a8; font-weight: bold">=</span> <a href="http://www.lua.org/manual/5.1/manual.html#lua_rawequal" style="color: #0e7c6b; text-decoration: none">lua_rawequal</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#lua_pop" style="color: #0e7c6b; text-decoration: none">lua_pop</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span>valid<span style="color: #2239a8; font-weight: bold">)</span>
    <span style="color: #2239a8; font-weight: bold">return</span> <a href="http://www.lua.org/manual/5.1/manual.html#lua_touserdata" style="color: #0e7c6b; text-decoration: none">lua_touserdata</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> idx<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#luaL_typerror" style="color: #0e7c6b; text-decoration: none">luaL_typerror</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> idx<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>typename<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">return</span> NULL<span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* get_metatable() returns the metatable for the given type. {{{1 */</span>

<span style="color: #2239a8; font-weight: bold">int</span> get_metatable<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_State" style="color: #0e7c6b; text-decoration: none">lua_State</a> <span style="color: #2239a8; font-weight: bold">*</span>L<span style="color: #2239a8; font-weight: bold">,</span> lua_apr_objtype <span style="color: #2239a8; font-weight: bold">*</span>T<span style="color: #2239a8; font-weight: bold">)</span>
<span style="color: #2239a8; font-weight: bold">{</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#luaL_getmetatable" style="color: #0e7c6b; text-decoration: none">luaL_getmetatable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>typename<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">if</span> <span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#lua_type" style="color: #0e7c6b; text-decoration: none">lua_type</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">!=</span> LUA_TTABLE<span style="color: #2239a8; font-weight: bold">)</span> <span style="color: #2239a8; font-weight: bold">{</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_pop" style="color: #0e7c6b; text-decoration: none">lua_pop</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#luaL_newmetatable" style="color: #0e7c6b; text-decoration: none">luaL_newmetatable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>typename<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#luaL_register" style="color: #0e7c6b; text-decoration: none">luaL_register</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> NULL<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>metamethods<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_newtable" style="color: #0e7c6b; text-decoration: none">lua_newtable</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#luaL_register" style="color: #0e7c6b; text-decoration: none">luaL_register</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> NULL<span style="color: #2239a8; font-weight: bold">,</span> T<span style="color: #2239a8; font-weight: bold">-&gt;</span>methods<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#lua_setfield" style="color: #0e7c6b; text-decoration: none">lua_setfield</a><span style="color: #2239a8; font-weight: bold">(</span>L<span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">,</span> <span style="color: #a8660d">"__index"</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>
  <span style="color: #2239a8; font-weight: bold">}</span>
  <span style="color: #2239a8; font-weight: bold">return</span> <span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">;</span>
<span style="color: #2239a8; font-weight: bold">}</span>

<span style="color: #558817">/* vim: set ts=2 sw=2 et tw=79 fen fdm=marker : */</span>
</pre></body></html>